# PHP・CodeIgniterアップデート計画書

## 1. プロジェクト概要

### 現状分析
- **PHPバージョン**: 5.3.7
- **フレームワーク**: CodeIgniter 3.1.x
- **主な懸念事項**:
  - PHP 5.3は2014年にサポート終了（セキュリティリスク）
  - 最新のライブラリやツールとの互換性問題
  - 将来的なメンテナンス困難

### 目標
- PHP 8.xへのアップグレード
- CodeIgniter 4への移行
- コンテナ環境への移行
- セキュリティとパフォーマンスの向上

## 2. 移行戦略

### アップグレード順序
1. **PHP 5.3.7 → PHP 7.4**（中間ステップとして）
2. **CodeIgniter 3.1.x → CodeIgniter 4.x**
3. **PHP 7.4 → PHP 8.x**

### 移行アプローチ
- **機能単位での垂直スライス方式**を採用
- 各機能グループを独立して移行
- 優先順位: 共通コンポーネント → 基本機能 → 複雑な機能

## 3. 実施計画

### サマリ

| フェーズ | 工数 | 備考 |
|---------|------|------|
| フェーズ0: 開発環境のコンテナ化 | 0.5人月 | 初期準備 |
| フェーズ1: 現状評価と準備 | 0.5人月 | 分析フェーズ |
| フェーズ2: 機能グループごとの移行 | 2.8人月 | 実際の機能実装 |
| フェーズ3: テストと最終調整 | 1.0人月 | 品質保証 |
| フェーズ4: 本番環境への展開 | 0.5人月 | リリース |
| **合計** | **5.3人月** | |

#### 工数計算の前提条件
- **1日あたりの稼働時間**: 8時間
- **月の稼働日数**: 20日（平日のみ）
- **1人月の総稼働時間**: 160時間（8時間 × 20日）
- **想定稼働率**: 80%（実質的な作業時間として）

上記の前提条件に基づき、5.3人月は約848時間（5.3人月 × 160時間）の作業時間に相当します。

### フェーズ0: 開発環境のコンテナ化（0.5人月）
- **Dockerコンテナ環境の構築**
  - PHP 5.3.7環境のDockerイメージ作成
  - PHP 7.4環境のDockerイメージ作成
  - PHP 8.x環境のDockerイメージ作成
  - MySQLなど必要なサービスのコンテナ化
  - docker-compose.ymlの作成

- **開発ワークフロー整備**
  - ボリュームマウントの設定
  - ホットリロード環境の構築
  - デバッグ環境の整備（Xdebugなど）

- **CI/CDパイプラインの構築**
  - 自動テスト環境の整備
  - 複数PHP環境での並行テスト設定

### フェーズ1: 現状評価と準備（0.5人月）
- **詳細な依存関係の調査**
  - コンテナ環境を活用した互換性テスト
  - 使用しているすべてのライブラリとバージョンの特定
  - PHPの互換性問題の洗い出し

- **テスト環境の構築**
  - コンテナ化された現行システムの完全なコピーを作成
  - 自動テストの作成（可能であれば）
  - 手動テストシナリオの文書化

### フェーズ2: 機能グループごとの移行（2.8人月）

#### 共通コンポーネント（0.6人月）
- XSYS_Controllerの移行（0.2人月）
- ヘルパー関数の移行（0.12人月）
- ユーティリティクラスの移行（0.16人月）
- 設定ファイルの移行（0.12人月）

#### 基本表示機能（0.32人月）
- Pagesコントローラーの移行（0.12人月）
- テンプレート（header/footer）の移行（0.12人月）
- 静的ページの移行（0.08人月）

#### レーサー管理機能（0.4人月）
- Racerコントローラーの移行（0.12人月）
- Racer_modelの移行（0.16人月）
- 関連ビューの移行（0.12人月）

#### レース管理機能（0.4人月）
- Raceコントローラーの移行（0.12人月）
- Race_modelの移行（0.16人月）
- 関連ビューの移行（0.12人月）

#### 大会管理機能（0.4人月）
- Meetコントローラーの移行（0.12人月）
- Meet_modelの移行（0.16人月）
- 関連ビューの移行（0.12人月）

#### ポイントシリーズ機能（0.32人月）
- Point_seriesコントローラーの移行（0.12人月）
- Pointseries_modelの移行（0.12人月）
- 関連ビューの移行（0.08人月）

#### ランキング機能（0.36人月）
- Ajocc_rankingコントローラーの移行（0.12人月）
- Ajoccranking_modelの移行（0.16人月）
- 関連ビューの移行（0.08人月）

### フェーズ3: テストと最終調整（1.0人月）
- **総合テスト**（0.5人月）
  - 機能テスト
  - 統合テスト
  - パフォーマンステスト
  - セキュリティテスト

- **パフォーマンス最適化**（0.3人月）
  - ボトルネックの特定と解消
  - キャッシュ戦略の実装
  - データベースクエリの最適化

- **ドキュメント作成**（0.2人月）
  - 開発者向けドキュメント
  - 運用者向けドキュメント
  - APIドキュメント

### フェーズ4: 本番環境への展開（0.5人月）
- 本番環境のコンテナ化
- 段階的デプロイ

## 4. 各機能グループの移行ステップ

各機能グループは以下の順序で移行を進める：

1. **PHP 7.4互換性対応**
   - 非推奨関数の置き換え
   - 型宣言の導入
   - エラー処理の変更

2. **CodeIgniter 4への移行**
   - 名前空間の導入
   - コントローラー/モデル/ビューの構造変更
   - ルーティングの更新

3. **PHP 8.x互換性対応**
   - 新構文の活用
   - 非推奨機能の対応
   - 型システムの強化

4. **最適化とリファクタリング**
   - パフォーマンス最適化
   - コード品質向上

## 5. 技術的変更点の詳細

### PHP 5→7.4への主な変更点
- mysql_*関数からmysqli_*またはPDOへの移行
- 厳格な型チェックへの対応
- 可変変数・間接参照の構文変更
- エラー処理の例外ベースへの移行
- 型宣言（引数・戻り値）の導入

### CodeIgniter 3→4への主な変更点
- 名前空間の導入
- ディレクトリ構造の変更
- 設定ファイル形式の変更（.env導入）
- コントローラー・モデル基底クラスの変更
- ルーティングシステムの変更
- ビューレンダリングの変更

### PHP 7.4→8.xへの主な変更点
- コンストラクタプロパティプロモーションの活用
- match式の導入
- Nullsafe演算子（?->）の活用
- 名前付き引数の活用
- Union型の導入
- JITコンパイラの最適化

## 6. コンテナ環境の構成

```yaml
# docker-compose.yml 概念図
version: '3'

services:
  # 現行環境（PHP 5.3.7 + CodeIgniter 3.1.x）
  app-php53:
    build:
      context: ./docker/php53
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 移行先環境（PHP 7.4 + CodeIgniter 4.x）
  app-php74:
    build:
      context: ./docker/php74
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # 最終目標環境（PHP 8.x + CodeIgniter 4.x）
  app-php8:
    build:
      context: ./docker/php8
    volumes:
      - ./:/var/www/html
    depends_on:
      - mysql

  # Webサーバー
  nginx:
    image: nginx:alpine
    ports:
      - "8000:80"
    volumes:
      - ./:/var/www/html
      - ./docker/nginx:/etc/nginx/conf.d
    depends_on:
      - app-php53  # 切り替え可能

  # データベース
  mysql:
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cyclox2
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

## 7. 工数見積もりの詳細

各フェーズの工数見積もりは、以下の要素を考慮して算出されています：

### フェーズ別工数の内訳
- **フェーズ0（0.5人月）**: Docker環境構築、CI/CD設定
- **フェーズ1（0.5人月）**: 現状分析、テスト環境構築
- **フェーズ2（2.8人月）**: 実際のコード移行作業（最も工数を要する）
- **フェーズ3（1.0人月）**: 品質保証とドキュメント整備
- **フェーズ4（0.5人月）**: 本番環境構築とデプロイ

### 工数算出の考慮事項
- 既存システムの複雑さ
- フレームワーク移行の技術的難易度
- テストとデバッグに必要な時間
- ドキュメント作成とナレッジ共有
- 予期しない問題への対応バッファ

## 8. リスクと対策

### 主なリスク
1. **互換性の問題**
   - 対策: 段階的なアップグレードと徹底したテスト

2. **カスタム拡張の再実装**
   - 対策: XSYS_Controller等のカスタムクラスをCodeIgniter 4の新しいアーキテクチャに適応させる

3. **ダウンタイム**
   - 対策: ブルー/グリーンデプロイメント戦略の採用

4. **学習曲線**
   - 対策: 開発チームへのトレーニングセッションの実施

### リスク軽減策
- 各フェーズでの徹底したテスト
- ロールバック計画の策定
- AIエージェントモードの活用による効率化
- 段階的な移行とリリース

## 9. AIエージェントモードの活用

AIエージェントモードは以下の作業で特に効果を発揮します：

1. **コード変換の自動化**
   - PHP 5→7→8の構文変更
   - CI3→CI4の移行パターン適用

2. **エラー解決の効率化**
   - 発生したエラーの原因特定と修正提案
   - 互換性問題の解決策提示

3. **ボイラープレートコードの生成**
   - 名前空間宣言
   - 型宣言の追加
   - 新しいクラス構造の生成

4. **ベストプラクティスの提案**
   - 新しい言語機能の活用方法
   - フレームワーク機能の最適な使用法

AIエージェントモードの活用により、通常より30-40%程度の効率化が見込まれます。

## 10. 成功基準

1. すべての機能がPHP 8.xとCodeIgniter 4で正常に動作する
2. セキュリティ脆弱性が解消される
3. パフォーマンスが現行システム以上になる
4. コンテナ環境で安定して動作する
5. 将来的な保守性が向上する

## 11. まとめ

本計画は、古いPHPバージョンとCodeIgniterフレームワークを使用したシステムを、最新の技術スタックに段階的に移行するための包括的なアプローチを提供します。コンテナ化と機能単位での垂直スライス方式を採用することで、リスクを最小限に抑えながら効率的に移行を進めることができます。AIエージェントモードの活用により、開発効率の向上も見込まれます。

総工数は約5.3人月と見積もられ、ベテランエンジニアとAIエージェントモードの組み合わせにより、効率的な実施が可能です。
